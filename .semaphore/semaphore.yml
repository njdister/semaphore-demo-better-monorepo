version: "v1.0"
name: Better Monorepo Project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Test JS Service 1
    dependencies: []
    run:
      when: "change_in('/javascript/js-service-1/', {default_branch: 'main'})"
    task:
      jobs:
        - name: Run Tests
          commands:
            - checkout
            - cd javascript/js-service-1
            - nvm use
            - npm ci
            - node test.js

  - name: Build JS Service 1
    dependencies: ["Test JS Service 1"]
    run:
      when: "change_in('/javascript/js-service-1/', {default_branch: 'main'})"
    task:
      jobs:
        - name: Build Docker Image
          commands:
            - checkout
            - cd javascript/js-service-1
            - docker build -t js-service-1:$(git rev-parse HEAD) .
            - echo 'We would upload docker image to ECS here'

  - name: Test JS Service 2
    dependencies: []
    run:
      when: "change_in('/javascript/js-service-2/', {default_branch: 'main'})"
    task:
      jobs:
        - name: Run Tests
          commands:
            - checkout
            - cd javascript/js-service-2
            - nvm use
            - npm ci
            - node test.js

  - name: Build JS Service 2
    dependencies: ["Test JS Service 2"]
    run:
      when: "change_in('/javascript/js-service-2/', {default_branch: 'main'})"
    task:
      jobs:
        - name: Build Docker Image
          commands:
            - checkout
            - cd javascript/js-service-2
            - docker build -t js-service-2:$(git rev-parse HEAD) .
            - echo 'We would upload docker image to ECS here'

  - name: Test Go Service 1
    dependencies: []
    run:
      when: "change_in('/golang/go-service-1/', {default_branch: 'main'})"
    task:
      jobs:
        - name: Run Tests
          commands:
            - checkout
            - cd golang/go-service-1
            - sem-version go 1.18
            - go test

  - name: Build Go Service 1
    dependencies: ["Test Go Service 1"]
    run:
      when: "change_in('/golang/go-service-1/', {default_branch: 'main'})"
    task:
      jobs:
        - name: Build Docker Image
          commands:
            - checkout
            - cd golang/go-service-1
            - docker build -t go-service-1:$(git rev-parse HEAD) .
            - echo 'We would upload docker image to ECS here'
